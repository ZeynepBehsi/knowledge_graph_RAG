<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Neo4j Chunk SimÃ¼lasyonu</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }

:root {
  --item1:  #3b82f6;
  --item1a: #8b5cf6;
  --item7:  #10b981;
  --item7a: #f59e0b;
  --dark:   #0f172a;
  --panel:  #1e293b;
  --card:   #253347;
  --border: #334155;
  --text:   #e2e8f0;
  --muted:  #94a3b8;
}

body { font-family:'Segoe UI',sans-serif; background:var(--dark); color:var(--text); height:100vh; overflow:hidden; display:flex; flex-direction:column; }

/* â”€â”€ TOP BAR â”€â”€ */
.topbar {
  background:var(--panel);
  border-bottom:1px solid var(--border);
  padding:12px 20px;
  display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px;
  flex-shrink:0;
}
.topbar-title { font-size:1.05em; font-weight:700; }
.topbar-title span { color:var(--item1); }

.controls { display:flex; gap:8px; flex-wrap:wrap; }
.btn {
  padding:7px 14px; border-radius:7px; border:1px solid var(--border);
  background:var(--card); color:var(--text); cursor:pointer; font-size:0.82em; font-weight:600;
  transition:all 0.2s;
}
.btn:hover { background:#334155; }
.btn.active { background:var(--item1); border-color:var(--item1); color:white; }
.btn.green  { background:#064e3b; border-color:#10b981; color:#6ee7b7; }
.btn.green:hover { background:#065f46; }

/* â”€â”€ MAIN LAYOUT â”€â”€ */
.layout { display:flex; flex:1; overflow:hidden; }

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar {
  width:300px; flex-shrink:0;
  background:var(--panel);
  border-right:1px solid var(--border);
  display:flex; flex-direction:column;
  overflow:hidden;
}
.sidebar-section { padding:14px 16px; border-bottom:1px solid var(--border); }
.sidebar-section h3 { font-size:0.8em; text-transform:uppercase; letter-spacing:0.08em; color:var(--muted); margin-bottom:10px; }

/* Legend */
.legend-item { display:flex; align-items:center; gap:8px; margin:5px 0; font-size:0.85em; }
.legend-dot  { width:12px; height:12px; border-radius:50%; flex-shrink:0; }

/* Stats */
.stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.stat-box { background:var(--card); border-radius:8px; padding:10px; text-align:center; }
.stat-num  { font-size:1.4em; font-weight:700; color:var(--item1); }
.stat-lbl  { font-size:0.72em; color:var(--muted); margin-top:2px; }

/* Node detail panel */
.node-panel { flex:1; overflow-y:auto; padding:14px 16px; }
.node-panel h3 { font-size:0.8em; text-transform:uppercase; letter-spacing:0.08em; color:var(--muted); margin-bottom:10px; }
.no-selection { color:var(--muted); font-size:0.85em; text-align:center; padding:30px 10px; line-height:1.6; }

.prop-row { display:flex; flex-direction:column; margin:8px 0; }
.prop-key  { font-size:0.72em; color:var(--muted); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:2px; }
.prop-val  { font-size:0.84em; background:var(--card); border-radius:6px; padding:7px 10px; word-break:break-all; line-height:1.5; }
.prop-val.mono { font-family:monospace; font-size:0.78em; color:#86efac; }

/* Embedding mini viz */
.emb-viz { display:flex; align-items:flex-end; gap:1.5px; height:40px; background:var(--card); border-radius:6px; padding:6px 8px; margin-top:4px; }
.emb-bar { width:4px; border-radius:2px 2px 0 0; transition:height 0.5s ease; }

/* Section badge */
.section-badge {
  display:inline-block; padding:3px 10px; border-radius:12px;
  font-size:0.78em; font-weight:700;
}

/* â”€â”€ GRAPH AREA â”€â”€ */
.graph-area { flex:1; position:relative; overflow:hidden; }
#graph-svg { width:100%; height:100%; }

/* SVG elements */
.node-circle { cursor:pointer; stroke-width:2; transition:stroke 0.2s; }
.node-circle:hover { stroke-width:3.5; }

.node-label {
  font-size:9px; fill:#94a3b8; text-anchor:middle;
  pointer-events:none; user-select:none;
}

.link { stroke-opacity:0.6; stroke-width:1.5; }
.link-label { font-size:8px; fill:#64748b; text-anchor:middle; pointer-events:none; }

/* Tooltip */
.tooltip {
  position:absolute; background:var(--card); border:1px solid var(--border);
  border-radius:8px; padding:10px 12px; font-size:0.82em; pointer-events:none;
  opacity:0; transition:opacity 0.15s; max-width:220px; z-index:10;
}

/* â”€â”€ BOTTOM INFO BAR â”€â”€ */
.infobar {
  background:var(--panel); border-top:1px solid var(--border);
  padding:7px 20px; font-size:0.78em; color:var(--muted);
  display:flex; gap:20px; flex-wrap:wrap; flex-shrink:0;
}
.infobar span b { color:var(--text); }

/* Scrollbar */
::-webkit-scrollbar { width:4px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:#334155; border-radius:4px; }

/* animate pulse */
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
.adding { animation:pulse 0.6s ease infinite; }
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="topbar-title">
    ğŸ•¸ï¸ Neo4j Graf SimÃ¼lasyonu â€” <span>Form 10-K Chunk Node'larÄ±</span>
  </div>
  <div class="controls">
    <button class="btn active" id="btnEdges" onclick="toggleEdges()">NEXT kenarlarÄ±: AÃ‡IK</button>
    <button class="btn active" id="btnLabels" onclick="toggleLabels()">Node etiketleri: AÃ‡IK</button>
    <button class="btn green"  id="btnAnimate" onclick="animateCreation()">â–¶ Chunk'larÄ± sÄ±rayla yarat</button>
    <button class="btn" onclick="resetZoom()">âŸ³ SÄ±fÄ±rla</button>
    <button class="btn" id="btnMode" onclick="toggleMode()" style="border-color:#f59e0b;color:#f59e0b;font-weight:700;">âš¡ GerÃ§ekÃ§i Mod</button>
  </div>
</div>

<!-- LAYOUT -->
<div class="layout">

  <!-- SIDEBAR -->
  <div class="sidebar">

    <!-- Mode Banner -->
    <div id="modeBanner" class="sidebar-section" style="background:#1a1200;border-bottom:2px solid #f59e0b;display:none;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
        <span style="font-size:1.1em;">âš¡</span>
        <span style="font-weight:700;color:#f59e0b;font-size:0.9em;">GERÃ‡EKÃ‡Ä° MOD</span>
      </div>
      <div style="font-size:0.8em;color:#fcd34d;line-height:1.6;">
        Bu gÃ¶rÃ¼nÃ¼m, Neo4j Browser'Ä±n gerÃ§ek davranÄ±ÅŸÄ±nÄ± yansÄ±tÄ±r:
      </div>
      <ul style="font-size:0.78em;color:#94a3b8;margin-top:6px;padding-left:16px;line-height:1.9;">
        <li>Node'lar <b style="color:#e2e8f0;">rastgele daÄŸÄ±lÄ±r</b> â€” gruplama yok</li>
        <li><b style="color:#e2e8f0;">NEXT kenarÄ± yok</b> â€” NB3 oluÅŸturmuyor</li>
        <li>Chunk'lar <b style="color:#e2e8f0;">birbirinden kopuk</b>, izole</li>
        <li>80 node olursa <b style="color:#e2e8f0;">Ã§ok daha kaotik</b></li>
      </ul>
    </div>

    <!-- Legend -->
    <div class="sidebar-section">
      <h3>BÃ¶lÃ¼mler (f10kItem)</h3>
      <div class="legend-item"><div class="legend-dot" style="background:var(--item1)"></div>item1 â€” Åirket TanÄ±mÄ±</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--item1a)"></div>item1a â€” Risk FaktÃ¶rleri</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--item7)"></div>item7 â€” Finansal TartÄ±ÅŸma</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--item7a)"></div>item7a â€” Piyasa Riski</div>
      <div class="legend-item" style="margin-top:10px;">
        <svg width="28" height="14"><line x1="0" y1="7" x2="28" y2="7" stroke="#64748b" stroke-width="1.5" stroke-dasharray="4,3"/><polygon points="22,4 28,7 22,10" fill="#64748b"/></svg>
        <span style="font-size:0.85em;">NEXT iliÅŸkisi</span>
      </div>
    </div>

    <!-- Stats -->
    <div class="sidebar-section">
      <h3>Graf Ä°statistikleri</h3>
      <div class="stats-grid">
        <div class="stat-box"><div class="stat-num" id="statNodes">20</div><div class="stat-lbl">:Chunk Node</div></div>
        <div class="stat-box"><div class="stat-num" id="statEdges">16</div><div class="stat-lbl">NEXT Kenar</div></div>
        <div class="stat-box"><div class="stat-num">1536</div><div class="stat-lbl">VektÃ¶r Boyutu</div></div>
        <div class="stat-box"><div class="stat-num">4</div><div class="stat-lbl">BÃ¶lÃ¼m</div></div>
      </div>
    </div>

    <!-- Node Detail -->
    <div class="node-panel">
      <h3>SeÃ§ili Node Ã–zellikleri</h3>
      <div id="nodeDetail">
        <div class="no-selection">
          Graf Ã¼zerinde bir node'a tÄ±klayarak tÃ¼m Ã¶zelliklerini gÃ¶rÃ¼ntÃ¼le.
          <br><br>
          BÃ¼yÃ¼tmek iÃ§in kaydÄ±rÄ±n, sÃ¼rÃ¼klemek iÃ§in tÄ±klayÄ±p tutun.
        </div>
      </div>
    </div>

  </div>

  <!-- GRAPH -->
  <div class="graph-area">
    <svg id="graph-svg"></svg>
    <div class="tooltip" id="tooltip"></div>
  </div>

</div>

<!-- BOTTOM INFO BAR -->
<div class="infobar">
  <span>Dosya: <b>0000950170-23-027948.json</b></span>
  <span>Åirket: <b>NetApp Inc.</b></span>
  <span>CIK: <b>1002047</b></span>
  <span>chunk_size: <b>2000 karakter</b></span>
  <span>chunk_overlap: <b>200 karakter</b></span>
  <span id="infoSelected" style="margin-left:auto;"></span>
</div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   VERI
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const COLORS = { item1:'#3b82f6', item1a:'#8b5cf6', item7:'#10b981', item7a:'#f59e0b' };
const FORM_ID = '0000950170-23-027948';

const TEXTS = {
  item1: [
    "NetApp is a global cloud-led, data-centric software company. We provide organizations the ability to manage and store data across on-premises, hybrid, and public cloud environments. Our solutions include cloud storage services, enterprise storage systems and software, and cloud operations services.",
    "Our customers include enterprises, service providers, governments, and universities worldwide. We deliver a unified data storage and management platform that helps customers build and maintain a cloud environment for their data wherever that data lives.",
    "We operate through two segments: Hybrid Cloud and Public Cloud. Our Hybrid Cloud segment includes our flagship ONTAP data management software, storage systems and related support, and professional services.",
    "The Public Cloud segment includes our cloud storage and cloud operations products, primarily in the areas of cloud data services. Products include Cloud Volumes ONTAP, Cloud Volumes Service, Azure NetApp Files, and related cloud services.",
    "Our go-to-market strategy includes both a direct sales force and an extensive partner ecosystem. We sell through resellers, system integrators, original equipment manufacturers (OEMs), and managed service providers globally.",
  ],
  item1a: [
    "We face intense competition in the markets for our products and services. Our principal competitors include Dell Technologies, Pure Storage, Hewlett Packard Enterprise, and cloud service providers such as Amazon Web Services, Microsoft Azure, and Google Cloud.",
    "Our quarterly operating results have fluctuated significantly in the past and may continue to fluctuate. Fluctuations may result from customer demand patterns, product transitions, supply chain disruptions, and macroeconomic conditions.",
    "Our business depends on our ability to attract, retain, and motivate key personnel. The market for highly qualified technical personnel is intensely competitive, particularly in areas such as cloud computing, software engineering, and data management.",
    "We rely on a limited number of sole-source and limited-source suppliers for components used in our products. Any disruption in the supply of these components could delay product deliveries, increase costs, or adversely affect our results.",
    "We are subject to cybersecurity risks. Any significant data breach, system outage, or other security incident could harm our reputation, result in legal liability, and adversely affect our business and operating results.",
  ],
  item7: [
    "Net revenues for fiscal 2023 were $6.36 billion, an increase of 6% compared to fiscal 2022. Product revenues increased 9% and service revenues increased 3%. The revenue growth was driven by strong demand for our hybrid cloud solutions and cloud storage services.",
    "Gross margin was 68.3% in fiscal 2023 compared to 67.8% in fiscal 2022. The improvement in gross margin was primarily due to a favorable revenue mix shift towards higher-margin software and cloud services, partially offset by increased supply chain costs.",
    "Operating expenses were $3.1 billion in fiscal 2023, compared to $2.9 billion in fiscal 2022. The increase was primarily driven by headcount-related costs and increased investment in research and development for cloud products.",
    "We generated $1.2 billion in cash from operating activities in fiscal 2023. Capital expenditures were $178 million. We returned $1.8 billion to shareholders through share repurchases and dividends during the fiscal year.",
    "As of April 28, 2023, we had $3.1 billion in cash, cash equivalents, and investments. Our debt consists of senior notes with varying maturities. We believe our current liquidity position is adequate to fund operations for the next 12 months.",
  ],
  item7a: [
    "We are exposed to market risk in the ordinary course of business. Market risk represents the risk of loss that may impact our financial position due to adverse changes in financial market prices and rates, including interest rates and foreign currency exchange rates.",
    "Our exposure to market risk for changes in interest rates relates primarily to our investment portfolio and outstanding debt. We manage interest rate risk by maintaining a portfolio of investments in a variety of securities including money market funds and short-term fixed income securities.",
    "We conduct business globally and are exposed to foreign currency exchange rate risk. We hedge a portion of our forecasted foreign currency-denominated revenues and expenses using foreign exchange forward contracts to reduce the impact of currency fluctuations.",
    "As of April 28, 2023, we had foreign exchange forward contracts outstanding with notional values totaling approximately $1.1 billion. A hypothetical 10% adverse change in foreign exchange rates would have resulted in a loss of approximately $63 million on these contracts.",
    "We do not use derivative financial instruments for speculative or trading purposes. We regularly review our hedging program and may make changes based on market conditions and our overall risk management objectives.",
  ]
};

// Node ve link Ã¼ret
const allNodes = [];
const allLinks = [];
let nodeIdx = 0;

['item1','item1a','item7','item7a'].forEach(section => {
  const sectionNodes = [];
  for (let i = 0; i < 5; i++) {
    const node = {
      id: `${section}-${i}`,
      chunkId: `${FORM_ID}-${section}-chunk${String(i).padStart(4,'0')}`,
      section,
      seqId: i,
      text: TEXTS[section][i],
      formId: FORM_ID,
      names: 'NetApp, Inc.',
      cik: '1002047',
      cusip6: '64110D',
      source: `https://www.sec.gov/Archives/edgar/data/1002047/000095017023027948/${FORM_ID}-${section}.htm`,
      embedding: Array.from({length:20}, () => (Math.random()-0.5)*0.08),
      visible: false,
    };
    allNodes.push(node);
    sectionNodes.push(node);
  }
  // NEXT edges
  for (let i = 0; i < sectionNodes.length-1; i++) {
    allLinks.push({
      source: sectionNodes[i].id,
      target: sectionNodes[i+1].id,
      type: 'NEXT'
    });
  }
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   D3 SETUP
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const svg = d3.select('#graph-svg');
const g   = svg.append('g');

// Zoom
const zoom = d3.zoom()
  .scaleExtent([0.3, 3])
  .on('zoom', e => g.attr('transform', e.transform));
svg.call(zoom);

// Markers (oklar)
const defs = svg.append('defs');
['item1','item1a','item7','item7a'].forEach(s => {
  defs.append('marker')
    .attr('id', `arrow-${s}`)
    .attr('viewBox','0 -4 10 8')
    .attr('refX', 22).attr('refY', 0)
    .attr('markerWidth', 6).attr('markerHeight', 6)
    .attr('orient','auto')
    .append('path')
    .attr('d','M0,-4L10,0L0,4')
    .attr('fill', COLORS[s])
    .attr('opacity', 0.7);
});

// Force simulation
const W = () => document.querySelector('.graph-area').clientWidth;
const H = () => document.querySelector('.graph-area').clientHeight;

const sim = d3.forceSimulation(allNodes)
  .force('link', d3.forceLink(allLinks).id(d=>d.id).distance(90).strength(0.6))
  .force('charge', d3.forceManyBody().strength(-280))
  .force('collide', d3.forceCollide(32))
  .force('x', d3.forceX(d => {
    const cx = {'item1':0.2,'item1a':0.45,'item7':0.7,'item7a':0.88};
    return W() * (cx[d.section]||0.5);
  }).strength(0.4))
  .force('y', d3.forceY(d => H()/2 + (d.seqId-2)*60).strength(0.25))
  .alphaDecay(0.02);

// Link layer
const linkG = g.append('g').attr('class','link-group');
// Node layer
const nodeG = g.append('g').attr('class','node-group');
// Label layer
const labelG = g.append('g').attr('class','label-group');

let linkSel, nodeSel, labelSel, labelEdgeSel;
let showEdges   = true;
let showLabels  = true;
let selectedId  = null;
let animating   = false;
let realisticMode = false;

function build() {
  const visNodes = allNodes.filter(d=>d.visible);
  const visLinks = allLinks.filter(d =>
    visNodes.find(n=>n.id===d.source.id||n.id===d.source) &&
    visNodes.find(n=>n.id===d.target.id||n.id===d.target)
  );

  // Links
  linkSel = linkG.selectAll('line').data(visLinks, d=>d.source.id+'-'+d.target.id);
  linkSel.exit().remove();
  linkSel = linkSel.enter().append('line')
    .attr('class','link')
    .attr('stroke', d => {
      const src = allNodes.find(n=>n.id===(d.source.id||d.source));
      return src ? COLORS[src.section] : '#64748b';
    })
    .attr('stroke-dasharray','5,3')
    .attr('marker-end', d => {
      const src = allNodes.find(n=>n.id===(d.source.id||d.source));
      return src ? `url(#arrow-${src.section})` : '';
    })
    .attr('opacity', showEdges ? 0.65 : 0)
    .merge(linkSel);

  // Nodes
  nodeSel = nodeG.selectAll('circle').data(visNodes, d=>d.id);
  nodeSel.exit().remove();
  const entered = nodeSel.enter().append('circle')
    .attr('class','node-circle')
    .attr('r', 16)
    .attr('fill', d => COLORS[d.section])
    .attr('fill-opacity', 0.15)
    .attr('stroke', d => COLORS[d.section])
    .on('click', (e,d) => selectNode(d))
    .on('mouseover', (e,d) => showTooltip(e,d))
    .on('mousemove', (e,d) => moveTooltip(e))
    .on('mouseout', hideTooltip)
    .call(d3.drag()
      .on('start', (e,d) => { if(!e.active) sim.alphaTarget(0.15).restart(); d.fx=d.x; d.fy=d.y; })
      .on('drag',  (e,d) => { d.fx=e.x; d.fy=e.y; })
      .on('end',   (e,d) => { if(!e.active) sim.alphaTarget(0); d.fx=null; d.fy=null; })
    );
  nodeSel = entered.merge(nodeSel);

  // Inner text (seq id)
  nodeG.selectAll('text.seq').data(visNodes, d=>d.id).join(
    enter => enter.append('text').attr('class','seq')
      .attr('text-anchor','middle').attr('dy','0.35em')
      .attr('font-size','9px').attr('fill','white').attr('pointer-events','none')
      .text(d=>`#${d.seqId}`)
  );

  // Labels
  labelSel = labelG.selectAll('text.nlabel').data(visNodes, d=>d.id);
  labelSel.exit().remove();
  labelSel = labelSel.enter().append('text')
    .attr('class','node-label nlabel')
    .attr('dy', 28)
    .text(d => d.section + '-' + d.seqId)
    .attr('opacity', showLabels ? 1 : 0)
    .merge(labelSel);

  sim.nodes(visNodes);
  sim.force('link').links(visLinks);
  sim.alpha(0.5).restart();
}

sim.on('tick', () => {
  if (linkSel) linkSel
    .attr('x1', d=>d.source.x).attr('y1', d=>d.source.y)
    .attr('x2', d=>d.target.x).attr('y2', d=>d.target.y);
  if (nodeSel) nodeSel.attr('cx', d=>d.x).attr('cy', d=>d.y);
  nodeG.selectAll('text.seq').attr('x', d=>d.x).attr('y', d=>d.y);
  if (labelSel) labelSel.attr('x', d=>d.x).attr('y', d=>d.y);
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TOGGLE FUNCTIONS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleEdges() {
  showEdges = !showEdges;
  document.getElementById('btnEdges').textContent = `NEXT kenarlarÄ±: ${showEdges?'AÃ‡IK':'KAPALI'}`;
  document.getElementById('btnEdges').classList.toggle('active', showEdges);
  linkG.selectAll('line').attr('opacity', showEdges ? 0.65 : 0);
}

function toggleLabels() {
  showLabels = !showLabels;
  document.getElementById('btnLabels').textContent = `Node etiketleri: ${showLabels?'AÃ‡IK':'KAPALI'}`;
  document.getElementById('btnLabels').classList.toggle('active', showLabels);
  labelG.selectAll('.nlabel').attr('opacity', showLabels ? 1 : 0);
}

function resetZoom() {
  svg.transition().duration(600).call(zoom.transform, d3.zoomIdentity.translate(50,20).scale(1));
}

function toggleMode() {
  realisticMode = !realisticMode;
  const btn = document.getElementById('btnMode');
  const banner = document.getElementById('modeBanner');

  if (realisticMode) {
    // GerÃ§ekÃ§i mod: kÃ¼meleme kuvvetlerini kaldÄ±r, NEXT kenarlarÄ±nÄ± gizle
    btn.style.background = '#f59e0b';
    btn.style.color = '#0f172a';
    btn.style.borderColor = '#f59e0b';
    btn.textContent = 'â† EÄŸitim Moduna DÃ¶n';
    banner.style.display = 'block';

    // Node'larÄ± rastgele konumlara daÄŸÄ±t
    allNodes.forEach(n => {
      n.x = W() * 0.1 + Math.random() * W() * 0.8;
      n.y = H() * 0.1 + Math.random() * H() * 0.8;
      n.vx = (Math.random() - 0.5) * 60;
      n.vy = (Math.random() - 0.5) * 60;
    });

    // Kuvvetleri gÃ¼ncelle: gruplama yok, Ã§ok daha yayÄ±lmÄ±ÅŸ
    sim
      .force('x', d3.forceX(W() / 2).strength(0.02))
      .force('y', d3.forceY(H() / 2).strength(0.02))
      .force('charge', d3.forceManyBody().strength(-180))
      .force('link', d3.forceLink(
        // GerÃ§ekÃ§i modda kenar YOK (NB3 oluÅŸturmaz)
        []
      ).id(d => d.id))
      .alpha(1).restart();

    // KenarlarÄ± gizle (gerÃ§ekte yok)
    showEdges = false;
    linkG.selectAll('line').attr('opacity', 0);
    document.getElementById('btnEdges').textContent = 'NEXT kenarlarÄ±: KAPALI';
    document.getElementById('btnEdges').classList.remove('active');
    document.getElementById('btnEdges').disabled = true;
    document.getElementById('btnEdges').style.opacity = '0.4';

  } else {
    // EÄŸitim moduna geri dÃ¶n
    btn.style.background = '';
    btn.style.color = '#f59e0b';
    btn.style.borderColor = '#f59e0b';
    btn.textContent = 'âš¡ GerÃ§ekÃ§i Mod';
    banner.style.display = 'none';

    document.getElementById('btnEdges').disabled = false;
    document.getElementById('btnEdges').style.opacity = '1';

    // Kuvvetleri eski haline getir
    sim
      .force('x', d3.forceX(d => {
        const cx = {'item1':0.2,'item1a':0.45,'item7':0.7,'item7a':0.88};
        return W() * (cx[d.section] || 0.5);
      }).strength(0.4))
      .force('y', d3.forceY(d => H()/2 + (d.seqId-2)*60).strength(0.25))
      .force('charge', d3.forceManyBody().strength(-280))
      .force('link', d3.forceLink(allLinks).id(d => d.id).distance(90).strength(0.6))
      .alpha(1).restart();

    showEdges = true;
    linkG.selectAll('line').attr('opacity', 0.65);
    document.getElementById('btnEdges').textContent = 'NEXT kenarlarÄ±: AÃ‡IK';
    document.getElementById('btnEdges').classList.add('active');

    build();
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ANIMATE CREATION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function animateCreation() {
  if (animating) return;
  animating = true;
  const btn = document.getElementById('btnAnimate');
  btn.textContent = 'â³ OluÅŸturuluyor...';
  btn.classList.add('adding');

  // Ã–nce hepsini gizle
  allNodes.forEach(n => n.visible = false);
  document.getElementById('statNodes').textContent = '0';
  document.getElementById('statEdges').textContent = '0';
  build();
  await sleep(400);

  let nc = 0, ec = 0;
  for (const n of allNodes) {
    n.visible = true;
    nc++;
    build();
    document.getElementById('statNodes').textContent = nc;
    // edge sayÄ±sÄ±
    ec = allLinks.filter(l => {
      const s = allNodes.find(x=>x.id===(l.source.id||l.source));
      const t = allNodes.find(x=>x.id===(l.target.id||l.target));
      return s?.visible && t?.visible;
    }).length;
    document.getElementById('statEdges').textContent = ec;
    await sleep(220);
  }

  btn.textContent = 'â–¶ Chunk\'larÄ± sÄ±rayla yarat';
  btn.classList.remove('adding');
  animating = false;
}

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   NODE SELECTION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function selectNode(d) {
  selectedId = d.id;
  // highlight
  nodeG.selectAll('circle')
    .attr('stroke-width', n => n.id===d.id ? 3.5 : 2)
    .attr('fill-opacity', n => n.id===d.id ? 0.35 : 0.15);

  document.getElementById('infoSelected').innerHTML = `SeÃ§ili: <b>${d.chunkId}</b>`;

  const sectionNames = {
    item1:'Åirket TanÄ±mÄ±', item1a:'Risk FaktÃ¶rleri',
    item7:'Finansal TartÄ±ÅŸma', item7a:'Piyasa Riski'
  };

  // Embedding mini bars
  const embBars = d.embedding.map(v => {
    const pct = Math.abs(v) / 0.08 * 100;
    const color = v >= 0 ? '#3b82f6' : '#ef4444';
    return `<div class="emb-bar" style="height:${Math.max(4,pct)}%;background:${color};"></div>`;
  }).join('');

  document.getElementById('nodeDetail').innerHTML = `
    <div class="prop-row">
      <div class="prop-key">f10kItem (BÃ¶lÃ¼m)</div>
      <div class="prop-val">
        <span class="section-badge" style="background:${COLORS[d.section]}22;color:${COLORS[d.section]};">
          ${d.section}
        </span>
        &nbsp;${sectionNames[d.section]}
      </div>
    </div>
    <div class="prop-row">
      <div class="prop-key">chunkId</div>
      <div class="prop-val mono">${d.chunkId}</div>
    </div>
    <div class="prop-row">
      <div class="prop-key">chunkSeqId</div>
      <div class="prop-val">${d.seqId} <span style="color:var(--muted);font-size:0.85em;">(bÃ¶lÃ¼mdeki sÄ±rasÄ±)</span></div>
    </div>
    <div class="prop-row">
      <div class="prop-key">text <span style="color:var(--muted);font-weight:400;">(ilk 200 karakter)</span></div>
      <div class="prop-val" style="font-size:0.8em;color:#cbd5e1;line-height:1.6;">"${d.text.slice(0,200)}..."</div>
    </div>
    <div class="prop-row">
      <div class="prop-key">formId</div>
      <div class="prop-val mono" style="font-size:0.76em;">${d.formId}</div>
    </div>
    <div class="prop-row">
      <div class="prop-key">names</div>
      <div class="prop-val">${d.names}</div>
    </div>
    <div class="prop-row">
      <div class="prop-key">cik</div>
      <div class="prop-val mono">${d.cik}</div>
    </div>
    <div class="prop-row">
      <div class="prop-key">source</div>
      <div class="prop-val" style="font-size:0.72em;color:#7dd3fc;word-break:break-all;">${d.source}</div>
    </div>
    <div class="prop-row">
      <div class="prop-key">textEmbedding <span style="color:var(--muted);font-weight:400;">[1536 float] â€” ilk 20 deÄŸer</span></div>
      <div class="emb-viz">${embBars}</div>
      <div style="font-size:0.72em;color:var(--muted);margin-top:4px;font-family:monospace;">
        [${d.embedding.slice(0,4).map(v=>v.toFixed(4)).join(', ')}, ...]
      </div>
    </div>
  `;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TOOLTIP
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const tip = document.getElementById('tooltip');
function showTooltip(e, d) {
  tip.style.opacity = 1;
  tip.innerHTML = `
    <div style="font-weight:700;color:${COLORS[d.section]};margin-bottom:4px;">${d.section} / chunk${d.seqId}</div>
    <div style="font-size:0.78em;color:#94a3b8;">${d.text.slice(0,80)}...</div>
  `;
}
function moveTooltip(e) {
  const rect = document.querySelector('.graph-area').getBoundingClientRect();
  tip.style.left = (e.clientX - rect.left + 14) + 'px';
  tip.style.top  = (e.clientY - rect.top  + 14) + 'px';
}
function hideTooltip() { tip.style.opacity = 0; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   INIT â€” tÃ¼m node'larÄ± gÃ¶ster
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
allNodes.forEach(n => n.visible = true);
build();

// Ä°lk zoom ayarÄ±
setTimeout(() => {
  svg.call(zoom.transform, d3.zoomIdentity.translate(60, 30).scale(0.95));
}, 300);
</script>
</body>
</html>
